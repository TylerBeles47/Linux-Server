<!DOCTYPE html>
<html class="writer-html5" lang="en">
<head>
  <meta name="readthedocs-addons-api-version" content="1" />
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />

    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-V9SYWYG92Y"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'G-V9SYWYG92Y');
    </script>
    
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>L2 Announcements / L2 Aware LB (Beta) &mdash; Cilium 1.18.2 documentation</title>
  <link rel="stylesheet" href="https://www.w3schools.com/w3css/4/w3.css">
    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=fa44fd50" />
    <link rel="stylesheet" type="text/css" href="../../_static/css/theme.css?v=ef282081" />
    <link rel="stylesheet" type="text/css" href="../../_static/parsed-literal.css?v=519ac8c2" />
    <link rel="stylesheet" type="text/css" href="../../_static/copybutton.css?v=378031d3" />
    <link rel="stylesheet" type="text/css" href="../../_static/editbutton.css?v=d53c7333" />
    <link rel="stylesheet" type="text/css" href="../../_static/helm-reference.css?v=2d9e6831" />
    <link rel="stylesheet" type="text/css" href="../../_static/wrapped-table.css?v=bc1f8164" />
    <link rel="stylesheet" type="text/css" href="../../_static/tabs.css?v=a5c4661c" />
  <link rel="stylesheet" href="../../_static/css/docsearch.min.css" type="text/css" />
    <link rel="canonical" href="https://docs.cilium.io/en/stable/network/l2-announcements.html" />
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../../_static/jquery.js?v=5d32c60e"></script>
        <script src="../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js?v=f9a590c1"></script>
        <script src="../../_static/doctools.js?v=888ff710"></script>
        <script src="../../_static/sphinx_highlight.js?v=4825356b"></script>
        <script src="../../_static/js/versionwarning.js?v=d4224a34"></script>
        <script src="../../_static/clipboardjs.min.js?v=bf393c17"></script>
        <script src="../../_static/copybutton.js?v=7c37f673"></script>
        <script src="../../_static/tabs.js?v=3030b3cb"></script>
    <script src="../../_static/js/theme.js"></script>

    <link rel="stylesheet" href="../../_static/css/github-button.css" type="text/css" />
    <script type="text/javascript" src="../../_static/js/github-button.js"></script>
    <script type="text/javascript" src="../../_static/js/docsearch.min.js"></script>
    <link rel="index" title="Index" href="../../genindex/" />
    <link rel="search" title="Search" href="../../search/" />
    <link rel="next" title="Node IPAM LB" href="../node-ipam/" />
    <link rel="prev" title="VXLAN Tunnel Endpoint (VTEP) Integration (beta)" href="../vtep/" /> 

  <meta name="twitter:card" content="summary"/>
  <meta name="twitter:site" content="@ciliumproject"/>
  <meta name="twitter:title" content="L2 Announcements / L2 Aware LB (Beta) &mdash; Cilium 1.18.2 documentation"/>
  <meta name="twitter:image" content="../../_static/../../_static/logo.svg"/>
<script async type="text/javascript" src="/_/static/javascript/readthedocs-addons.js"></script><meta name="readthedocs-project-slug" content="cilium" /><meta name="readthedocs-version-slug" content="stable" /><meta name="readthedocs-resolver-filename" content="/network/l2-announcements/" /><meta name="readthedocs-http-status" content="200" /></head>

<body class="wy-body-for-nav">
  <header class="wy-header">
      <div class="wy-header-left">
          
          
          <a href="https://www.cilium.io" class="wy-header-logo-wrapper">
            
              <img src="../../_static/logo.svg" class="logo" alt="Logo"/>
          </a><span class="wy-github-stars">
            <span class="github-btn github-stargazers github-btn-large">
              <a
                class="gh-btn"
                href="https://github.com/cilium/cilium"
                rel="noopener noreferrer"
                target="_blank"
              >
                <span class="gh-ico" aria-hidden="true"></span>
                <span class="gh-text">GitHub Stars</span>
              </a>
              <a
                class="gh-count"
                href="https://github.com/cilium/cilium/stargazers"
                rel="noopener noreferrer"
                target="_blank"
                aria-label={`${this.state.stars} stargazers on GitHub`}
                style="margin-left: 0px;"
              >
              </a>

              <a
                class="gh-btn"
                href="https://slack.cilium.io/"
                rel="noopener noreferrer"
                target="_blank"
                style="margin-left: 15px;"
              >
                <img style="height: 1em;" src="../../_static/icons/slack.inline.svg" alt="slack_icon">
                <span class="gh-text">Join Slack</span>
            </a>
            </span>
        </span>
    </div>

    <nav class="wy-main-nav">
      <input name="wy-main-nav-checkbox" id="wy-main-nav-checkbox" class="wy-main-nav-checkbox" type="checkbox">
      <label for="wy-main-nav-checkbox" class="wy-main-nav-toggle">Menu</label>
      <ul id="#wy-main-nav-menu" class="wy-main-nav-menu">
        <li><a class="w3-hover-text-blue" href="https://cilium.io/enterprise/">Enterprise</a></li>
        <li>
          <div style="background-color: white; font-size: 16px; font-weight: 600; margin-left: 40px" class="w3-dropdown-hover">
            <button class="w3-button w3-white w3-hover-white w3-hover-text-blue">Learn <span class="triangle">▾</span></button>
            <div class="w3-dropdown-content w3-bar-block w3-card-4">
              <a style = "margin-left: 0px; display: inline-flex;" href="https://cilium.io/labs/categories/getting-started" class="w3-bar-item w3-button w3-hover-white w3-hover-text-blue">
                <img style="height: 1.5em; margin-right: .5em" src="../../_static/icons/labs.inline.svg" alt="labs-icon">
                Labs
              </a>
              <a style = "margin-left: 0px; display: inline-flex;" href="https://cilium.io/get-started" class="w3-bar-item w3-button w3-hover-white w3-hover-text-blue">
                <img style="height: 1.5em; margin-right: .5em" src="../../_static/icons/get-started.inline.svg" alt="get-started-icon">
                Get Started
              </a>
              <a style = "margin-left: 0px; display: inline-flex; padding-right: 10px;" href="https://cilium.io/get-involved" class="w3-bar-item w3-button w3-hover-white w3-hover-text-blue">
                <img style="height: 1.5em; margin-right: .5em" src="../../_static/icons/get-involved.inline.svg" alt="get-involved-icon">
                Get Involved
              </a>
              <a style = "margin-left: 0px; display: inline-flex;" href="https://cilium.io/get-help" class="w3-bar-item w3-button w3-hover-white w3-hover-text-blue">
                <img style="height: 1.5em; margin-right: .5em" src="../../_static/icons/get-help.inline.svg" alt="get-help-icon">
                Get Help
              </a>
            </div>
          </div>

        </li>
        <li>
          <div style="background-color: white; font-size: 16px;font-weight: 600; margin-left: 40px" class="w3-dropdown-hover">
            <button class="w3-button w3-white w3-hover-white w3-hover-text-blue">News and media <span class="triangle">▾</span></i></button>
            <div class="w3-dropdown-content w3-bar-block w3-card-4">
              <a style = "margin-left: 0px; display: inline-flex;" href="https://cilium.io/adopters" class="w3-bar-item w3-button w3-hover-white w3-hover-text-blue">
                <img style="height: 1.5em; margin-right: .5em" src="../../_static/icons/adopters.inline.svg" alt="adopters-icon">
                Adopters
              </a>
              <a style = "margin-left: 0px; display: inline-flex;" href="https://cilium.io/blog" class="w3-bar-item w3-button w3-hover-white w3-hover-text-blue">
                <img style="height: 1.5em; margin-right: .5em" src="../../_static/icons/blog.inline.svg" alt="blog-icon">
                Blog
              </a>
              <a style = "margin-left: 0px; display: inline-flex;" href="https://github.com/cncf/artwork/blob/master/examples/incubating.md#cilium-logos" class="w3-bar-item w3-button w3-hover-white w3-hover-text-blue">
                <img style="height: 1.5em; margin-right: .5em" src="../../_static/icons/branding.inline.svg" alt="branding-icon">
                Branding
              </a>
              <a style = "margin-left: 0px; display: inline-flex;" href="https://cilium.io/newsletter" class="w3-bar-item w3-button w3-hover-white w3-hover-text-blue">
                <img style="height: 1.5em; margin-right: .5em" src="../../_static/icons/newsletter.inline.svg" alt="newsletter-icon">
                Newsletter
              </a>
            </div>
          </div>

        </li>
        <li><a class="w3-hover-text-blue" href="https://docs.cilium.io/en/stable/">Documentation</a></li>
      </ul>
    </nav>
  </header> 
  <div class="wy-grid-for-nav">
    <div class="wy-nav-wrapper" data-toggle="wy-nav-shift" >
        <div class="wy-side-nav-search" >
            <!--
              <div class="version">
                stable
              </div> -->
<div role="search">
  <div id="rtd-search-form" class="wy-form">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </div>
</div>
        </div>

      <nav class="wy-nav-side">
      <div class="wy-side-scroll"><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Overview</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../overview/intro/">Introduction to Cilium &amp; Hubble</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../overview/component-overview/">Component Overview</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Getting Started</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../gettingstarted/k8s-install-default/">Cilium Quick Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../gettingstarted/demo/">Getting Started with the Star Wars Demo</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../gettingstarted/terminology/">Terminology</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../gettingstarted/gettinghelp/">Getting Help</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Advanced Installation</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../installation/taints/">Considerations on Node Pool Taints and Unmanaged Pods</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../installation/k8s-install-helm/">Installation using Helm</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../installation/k8s-install-migration/">Migrating a cluster to Cilium</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../installation/k8s-toc/">Installation with K8s distributions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../installation/external-toc/">External Installers</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Networking</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../concepts/">Networking Concepts</a></li>
<li class="toctree-l1"><a class="reference internal" href="../kubernetes/">Kubernetes Networking</a></li>
<li class="toctree-l1"><a class="reference internal" href="../bgp-toc/">BGP</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ebpf/">eBPF Datapath</a></li>
<li class="toctree-l1"><a class="reference internal" href="../clustermesh/">Multi-cluster Networking</a></li>
<li class="toctree-l1"><a class="reference internal" href="../egress-gateway-toc/">Egress Gateway</a></li>
<li class="toctree-l1"><a class="reference internal" href="../servicemesh/">Service Mesh</a></li>
<li class="toctree-l1"><a class="reference internal" href="../vtep/">VXLAN Tunnel Endpoint (VTEP) Integration (beta)</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">L2 Announcements / L2 Aware LB (Beta)</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#configuration">Configuration</a></li>
<li class="toctree-l2"><a class="reference internal" href="#prerequisites">Prerequisites</a></li>
<li class="toctree-l2"><a class="reference internal" href="#limitations">Limitations</a></li>
<li class="toctree-l2"><a class="reference internal" href="#policies">Policies</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#service-selector">Service Selector</a></li>
<li class="toctree-l3"><a class="reference internal" href="#node-selector">Node Selector</a></li>
<li class="toctree-l3"><a class="reference internal" href="#interfaces">Interfaces</a></li>
<li class="toctree-l3"><a class="reference internal" href="#ip-types">IP Types</a></li>
<li class="toctree-l3"><a class="reference internal" href="#status">Status</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#leader-election">Leader Election</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#leases">Leases</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#sizing-client-rate-limit">Sizing client rate limit</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#failover">Failover</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#troubleshooting">Troubleshooting</a></li>
<li class="toctree-l2"><a class="reference internal" href="#l2-pod-announcements">L2 Pod Announcements</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../node-ipam/">Node IPAM LB</a></li>
<li class="toctree-l1"><a class="reference internal" href="../pod-mac-address/">Use a Specific MAC Address for a Pod</a></li>
<li class="toctree-l1"><a class="reference internal" href="../multicast/">Multicast Support in Cilium (Beta)</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Security</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../security/">Securing Networks with Cilium</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../security/network/">Overview of Network Security</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../security/policy/">Overview of Network Policy</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../security/restrict-pod-access/">Restricting privileged Cilium pod access</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../security/threat-model/">Threat Model</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Observability</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../observability/hubble/">Network Observability with Hubble</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../observability/grafana/">Running Prometheus &amp; Grafana</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../observability/metrics/">Monitoring &amp; Metrics</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../observability/visibility/">Layer 7 Protocol Visibility</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Operations</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../operations/system_requirements/">System Requirements</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../operations/upgrade/">Upgrade Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../configuration/">Configuration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../operations/performance/">Performance &amp; Scalability</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../operations/troubleshooting/">Troubleshooting</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Community</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../community/governance/">Governance</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../community/community/">Community Meetings</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../community/community/#slack">Slack</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../community/community/#special-interest-groups">Special Interest Groups</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../community/roadmap/">Roadmap</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Contributor Guide</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../contributing/development/">Development</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../contributing/release/">Release Management</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../contributing/testing/">Testing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../contributing/docs/">Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api/">API Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../grpcapi/">gRPC API Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../sdpapi/">SDP gRPC API Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../internals/">Internals</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../cheatsheet/">Command Cheatsheet</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../cmdref/">Command Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../helm-reference/">Helm Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../kvstore/">Key-Value Store</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../further_reading/">Further Reading</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../glossary/">Glossary</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Reference Guides</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../reference-guides/bpf/">BPF and XDP Reference Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../reference-guides/xfrm/">XFRM Reference Guide</a></li>
</ul>

        </div>
      </div>
      </nav>
    </div>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../">Cilium</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../" class="icon icon-home" aria-label="Home"></a></li>
      <li class="breadcrumb-item active">L2 Announcements / L2 Aware LB (Beta)</li>

  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="l2-announcements-l2-aware-lb-beta">
<span id="l2-announcements"></span><h1>L2 Announcements / L2 Aware LB (Beta)<a class="headerlink" href="#l2-announcements-l2-aware-lb-beta" title="Permalink to this heading"></a></h1>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>This is a beta feature. Please provide feedback and file a GitHub issue if
you experience any problems.</p>
</div>
<p>L2 Announcements is a feature which makes services visible and reachable on
the local area network. This feature is primarily intended for on-premises
deployments within networks without BGP based routing such as office or
campus networks.</p>
<p>When used, this feature will respond to ARP queries for ExternalIPs and/or
LoadBalancer IPs. These IPs are Virtual IPs (not installed on network
devices) on multiple nodes, so for each service one node at a time will respond
to the ARP queries and respond with its MAC address. This node will perform
load balancing with the service load balancing feature, thus acting as a
north/south load balancer.</p>
<p>The advantage of this feature over NodePort services is that each service can
use a unique IP so multiple services can use the same port numbers. When using
NodePorts, it is up to the client to decide to which host to send traffic, and if a node
goes down, the IP+Port combo becomes unusable. With L2 announcements the service
VIP simply migrates to another node and will continue to work.</p>
<section id="configuration">
<span id="l2-announcements-settings"></span><h2>Configuration<a class="headerlink" href="#configuration" title="Permalink to this heading"></a></h2>
<p>The L2 Announcements feature and all the requirements can be enabled as follows:</p>
<div class="sphinx-tabs docutils container">
<div aria-label="Tabbed content" class="closeable" role="tablist"><button aria-controls="panel-0-SGVsbQ==" aria-selected="true" class="sphinx-tabs-tab group-tab" id="tab-0-SGVsbQ==" name="SGVsbQ==" role="tab" tabindex="0">Helm</button><button aria-controls="panel-0-Q29uZmlnTWFw" aria-selected="false" class="sphinx-tabs-tab group-tab" id="tab-0-Q29uZmlnTWFw" name="Q29uZmlnTWFw" role="tab" tabindex="-1">ConfigMap</button></div><div aria-labelledby="tab-0-SGVsbQ==" class="sphinx-tabs-panel group-tab" id="panel-0-SGVsbQ==" name="SGVsbQ==" role="tabpanel" tabindex="0"><pre class="literal-block">$ helm upgrade cilium cilium/cilium --version 1.18.2 \
   --namespace kube-system \
   --reuse-values \
   --set l2announcements.enabled=true \
   --set k8sClientRateLimit.qps={QPS} \
   --set k8sClientRateLimit.burst={BURST} \
   --set kubeProxyReplacement=true \
   --set k8sServiceHost=${API_SERVER_IP} \
   --set k8sServicePort=${API_SERVER_PORT}</pre>
</div><div aria-labelledby="tab-0-Q29uZmlnTWFw" class="sphinx-tabs-panel group-tab" hidden="true" id="panel-0-Q29uZmlnTWFw" name="Q29uZmlnTWFw" role="tabpanel" tabindex="0"><div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">enable-l2-announcements</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
<span class="nt">kube-proxy-replacement</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
<span class="nt">k8s-client-qps</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">{</span><span class="nv">QPS</span><span class="p p-Indicator">}</span>
<span class="nt">k8s-client-burst</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">{</span><span class="nv">BURST</span><span class="p p-Indicator">}</span>
</pre></div>
</div>
</div></div>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>Sizing the client rate limit (<code class="docutils literal notranslate"><span class="pre">k8sClientRateLimit.qps</span></code> and <code class="docutils literal notranslate"><span class="pre">k8sClientRateLimit.burst</span></code>)
is important when using this feature due to increased API usage. See <a class="reference internal" href="#sizing-client-rate-limit"><span class="std std-ref">Sizing client rate limit</span></a> for sizing guidelines.</p>
</div>
</section>
<section id="prerequisites">
<h2>Prerequisites<a class="headerlink" href="#prerequisites" title="Permalink to this heading"></a></h2>
<ul class="simple">
<li><p>Kube Proxy replacement mode must be enabled. For more information, see
<a class="reference internal" href="../kubernetes/kubeproxy-free/#kubeproxy-free"><span class="std std-ref">Kubernetes Without kube-proxy</span></a>.</p></li>
<li><p>All devices on which L2 Aware LB will be announced should be enabled and included in the
<code class="docutils literal notranslate"><span class="pre">--devices</span></code> flag or <code class="docutils literal notranslate"><span class="pre">devices</span></code> Helm option if explicitly set, see <a class="reference internal" href="../kubernetes/kubeproxy-free/#nodeport-devices"><span class="std std-ref">NodePort Devices, Port and Bind settings</span></a>.</p></li>
<li><p>The <code class="docutils literal notranslate"><span class="pre">externalIPs.enabled=true</span></code> Helm option must be set, if usage of externalIPs
is desired. Otherwise service load balancing for external IPs is disabled.</p></li>
</ul>
</section>
<section id="limitations">
<h2>Limitations<a class="headerlink" href="#limitations" title="Permalink to this heading"></a></h2>
<ul class="simple">
<li><p>The feature currently does not support IPv6/NDP.</p></li>
<li><p>Due to the way L3-&gt;L2 translation protocols work, one node receives all
ARP requests for a specific IP, so no load balancing can happen before traffic hits the cluster.</p></li>
<li><p>The feature currently has no traffic balancing mechanism so nodes within the
same policy might be asymmetrically loaded. For details see <a class="reference internal" href="#l2-announcements-leader-election"><span class="std std-ref">Leader Election</span></a>.</p></li>
<li><p>The feature is incompatible with the <code class="docutils literal notranslate"><span class="pre">externalTrafficPolicy:</span> <span class="pre">Local</span></code> on services as it may cause
service IPs to be announced on nodes without pods causing traffic drops.</p></li>
</ul>
</section>
<section id="policies">
<h2>Policies<a class="headerlink" href="#policies" title="Permalink to this heading"></a></h2>
<p>Policies provide fine-grained control over which services should be announced,
where, and how. This is an example policy using all optional fields:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;cilium.io/v2alpha1&quot;</span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">CiliumL2AnnouncementPolicy</span>
<span class="nt">metadata</span><span class="p">:</span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">policy1</span>
<span class="nt">spec</span><span class="p">:</span>
<span class="w">  </span><span class="nt">serviceSelector</span><span class="p">:</span>
<span class="w">    </span><span class="nt">matchLabels</span><span class="p">:</span>
<span class="w">      </span><span class="nt">color</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">blue</span>
<span class="w">  </span><span class="nt">nodeSelector</span><span class="p">:</span>
<span class="w">    </span><span class="nt">matchExpressions</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">key</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">node-role.kubernetes.io/control-plane</span>
<span class="w">        </span><span class="nt">operator</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">DoesNotExist</span>
<span class="w">  </span><span class="nt">interfaces</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">^eth[0-9]+</span>
<span class="w">  </span><span class="nt">externalIPs</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
<span class="w">  </span><span class="nt">loadBalancerIPs</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
</pre></div>
</div>
<section id="service-selector">
<h3>Service Selector<a class="headerlink" href="#service-selector" title="Permalink to this heading"></a></h3>
<p>The service selector is a <a class="reference external" href="https://kubernetes.io/docs/concepts/overview/working-with-objects/labels/">label selector</a>
that determines which services are selected by this policy. If no service
selector is provided, all services are selected by the policy. A service must have
<a class="reference external" href="https://kubernetes.io/docs/concepts/services-networking/service/#load-balancer-class">loadBalancerClass</a>
unspecified or set to <code class="docutils literal notranslate"><span class="pre">io.cilium/l2-announcer</span></code> to be selected by a policy for announcement.</p>
<p>There are a few special purpose selector fields which don’t match on labels but
instead on other metadata like <code class="docutils literal notranslate"><span class="pre">.meta.name</span></code> or <code class="docutils literal notranslate"><span class="pre">.meta.namespace</span></code>.</p>
<table class="docutils align-default">
<tbody>
<tr class="row-odd"><td><p>Selector</p></td>
<td><p>Field</p></td>
</tr>
<tr class="row-even"><td><p>io.kubernetes.service.namespace</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">.meta.namespace</span></code></p></td>
</tr>
<tr class="row-odd"><td><p>io.kubernetes.service.name</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">.meta.name</span></code></p></td>
</tr>
</tbody>
</table>
</section>
<section id="node-selector">
<h3>Node Selector<a class="headerlink" href="#node-selector" title="Permalink to this heading"></a></h3>
<p>The node selector field is a <a class="reference external" href="https://kubernetes.io/docs/concepts/overview/working-with-objects/labels/">label selector</a>
which determines which nodes are candidates to announce the services from.</p>
<p>It might be desirable to pick a subset of nodes in you cluster, since the chosen
node (see <a class="reference internal" href="#l2-announcements-leader-election"><span class="std std-ref">Leader Election</span></a>) will act as the north/south
load balancer for all of the traffic for a particular service.</p>
</section>
<section id="interfaces">
<h3>Interfaces<a class="headerlink" href="#interfaces" title="Permalink to this heading"></a></h3>
<p>The interfaces field is a list of regular expressions (<a class="reference external" href="https://pkg.go.dev/regexp/syntax">golang syntax</a>)
that determine over which network interfaces the selected services will be
announced. This field is optional, if not specified all interfaces will be used.</p>
<p>The expressions are OR-ed together, so any network device matching any of the
expressions will be matched.</p>
<p>L2 announcements only work if the selected devices are also part of the set of
devices specified in the <code class="docutils literal notranslate"><span class="pre">devices</span></code> Helm option, see <a class="reference internal" href="../kubernetes/kubeproxy-free/#nodeport-devices"><span class="std std-ref">NodePort Devices, Port and Bind settings</span></a>.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>This selector is NOT a security feature, services will still be available
via interfaces when not advertised (for example by hard-coding ARP entries).</p>
</div>
</section>
<section id="ip-types">
<h3>IP Types<a class="headerlink" href="#ip-types" title="Permalink to this heading"></a></h3>
<p>The <code class="docutils literal notranslate"><span class="pre">externalIPs</span></code> and <code class="docutils literal notranslate"><span class="pre">loadBalancerIPs</span></code> fields determine what sort of IPs
are announced. They are both set to <code class="docutils literal notranslate"><span class="pre">false</span></code> by default, so a functional policy should always
have one or both set to <code class="docutils literal notranslate"><span class="pre">true</span></code>.</p>
<p>If <code class="docutils literal notranslate"><span class="pre">externalIPs</span></code> is <code class="docutils literal notranslate"><span class="pre">true</span></code> all IPs in <a class="reference external" href="https://kubernetes.io/docs/concepts/services-networking/service/#external-ips">.spec.externalIPs</a>
field are announced. These IPs are managed by service authors.</p>
<p>If <code class="docutils literal notranslate"><span class="pre">loadBalancerIPs</span></code> is <code class="docutils literal notranslate"><span class="pre">true</span></code> all IPs in the service’s <code class="docutils literal notranslate"><span class="pre">.status.loadbalancer.ingress</span></code> field
are announced. These can be assigned by <a class="reference internal" href="../lb-ipam/#lb-ipam"><span class="std std-ref">LoadBalancer IP Address Management (LB IPAM)</span></a> which can be configured
by cluster admins for better control over which IPs can be allocated.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>If a user intends to use <code class="docutils literal notranslate"><span class="pre">externalIPs</span></code>, the <code class="docutils literal notranslate"><span class="pre">externalIPs.enable=true</span></code>
Helm option should be set to enable service load balancing for external IPs.</p>
</div>
</section>
<section id="status">
<h3>Status<a class="headerlink" href="#status" title="Permalink to this heading"></a></h3>
<p>If a policy is invalid for any number of reasons, the status of the policy will reflect that.
For example if an invalid match expression is provided:</p>
<div class="highlight-shell-session notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>kubectl<span class="w"> </span>describe<span class="w"> </span>l2announcement
<span class="go">Name:         policy1</span>
<span class="go">Namespace:</span>
<span class="go">Labels:       &lt;none&gt;</span>
<span class="go">Annotations:  &lt;none&gt;</span>
<span class="go">API Version:  cilium.io/v2alpha1</span>
<span class="go">Kind:         CiliumL2AnnouncementPolicy</span>
<span class="go">Metadata:</span>
<span class="gp">  #</span><span class="o">[</span>...<span class="o">]</span>
<span class="go">Spec:</span>
<span class="gp">  #</span><span class="o">[</span>...<span class="o">]</span>
<span class="go">  Service Selector:</span>
<span class="go">    Match Expressions:</span>
<span class="go">      Key:       something</span>
<span class="go">      Operator:  NotIn</span>
<span class="go">      Values:</span>
<span class="go">Status:</span>
<span class="go">  Conditions:</span>
<span class="go">    Last Transition Time:  2023-05-12T15:39:01Z</span>
<span class="go">    Message:               values: Invalid value: []string(nil): for &#39;in&#39;, &#39;notin&#39; operators, values set can&#39;t be empty</span>
<span class="go">    Observed Generation:   1</span>
<span class="go">    Reason:                error</span>
<span class="go">    Status:                True</span>
<span class="go">    Type:                  io.cilium/bad-service-selector</span>
</pre></div>
</div>
<p>The status of these error conditions will go to <code class="docutils literal notranslate"><span class="pre">False</span></code> as soon as the user
updates the policy to resolve the error.</p>
</section>
</section>
<section id="leader-election">
<span id="l2-announcements-leader-election"></span><h2>Leader Election<a class="headerlink" href="#leader-election" title="Permalink to this heading"></a></h2>
<p>Due to the way ARP/NDP works, hosts only store one MAC address per IP, that being
the latest reply they see. This means that only one node in the cluster is allowed
to reply to requests for a given IP.</p>
<p>To implement this behavior, every Cilium agent resolves which services are
selected for its node and will start participating in leader election for every
service. We use Kubernetes <a class="reference external" href="https://kubernetes.io/docs/concepts/architecture/leases/">lease mechanism</a>
to achieve this. Each service translates to a lease, the lease holder will start
replying to requests on the selected interfaces.</p>
<p>The lease mechanism is a first come, first serve picking order. So the first
node to claim a lease gets it. This might cause asymmetric traffic distribution.</p>
<section id="leases">
<h3>Leases<a class="headerlink" href="#leases" title="Permalink to this heading"></a></h3>
<p>The leases are created in the same namespace where Cilium is deployed,
typically <code class="docutils literal notranslate"><span class="pre">kube-system</span></code>. You can inspect the leases with the following command:</p>
<div class="highlight-shell-session notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>kubectl<span class="w"> </span>-n<span class="w"> </span>kube-system<span class="w"> </span>get<span class="w"> </span>lease
<span class="go">NAME                                  HOLDER                                                    AGE</span>
<span class="go">cilium-l2announce-default-deathstar   worker-node                                               2d20h</span>
<span class="go">cilium-operator-resource-lock         worker-node2-tPDVulKoRK                                   2d20h</span>
<span class="go">kube-controller-manager               control-plane-node_9bd97f6c-cd0c-4565-8486-e718deb310e4   2d21h</span>
<span class="go">kube-scheduler                        control-plane-node_2c490643-dd95-4f73-8862-139afe771ffd   2d21h</span>
</pre></div>
</div>
<p>The leases starting with <code class="docutils literal notranslate"><span class="pre">cilium-l2announce-</span></code> are leases used by this feature.
The last part of the name is the namespace and service name. The holder indicates
the name of the node that currently holds the lease and thus announced the IPs
of that given service.</p>
<p>To inspect a lease:</p>
<div class="highlight-shell-session notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>kubectl<span class="w"> </span>-n<span class="w"> </span>kube-system<span class="w"> </span>get<span class="w"> </span>lease/cilium-l2announce-default-deathstar<span class="w"> </span>-o<span class="w"> </span>yaml
<span class="go">apiVersion: coordination.k8s.io/v1</span>
<span class="go">kind: Lease</span>
<span class="go">metadata:</span>
<span class="go">  creationTimestamp: &quot;2023-05-09T15:13:32Z&quot;</span>
<span class="go">  name: cilium-l2announce-default-deathstar</span>
<span class="go">  namespace: kube-system</span>
<span class="go">  resourceVersion: &quot;449966&quot;</span>
<span class="go">  uid: e3c9c020-6e24-4c5c-9df9-d0c50f6c4cec</span>
<span class="go">spec:</span>
<span class="go">  acquireTime: &quot;2023-05-09T15:14:20.108431Z&quot;</span>
<span class="go">  holderIdentity: worker-node</span>
<span class="go">  leaseDurationSeconds: 3</span>
<span class="go">  leaseTransitions: 1</span>
<span class="go">  renewTime: &quot;2023-05-12T12:15:26.773020Z&quot;</span>
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">acquireTime</span></code> is the time at which the current leader acquired the lease.
The <code class="docutils literal notranslate"><span class="pre">holderIdentity</span></code> is the name of the current holder/leader node.
If the leader does not renew the lease for <code class="docutils literal notranslate"><span class="pre">leaseDurationSeconds</span></code> seconds a
new leader is chosen. <code class="docutils literal notranslate"><span class="pre">leaseTransitions</span></code> indicates how often the lease changed
hands and <code class="docutils literal notranslate"><span class="pre">renewTime</span></code> the last time the leader renewed the lease.</p>
<p>There are three Helm options that can be tuned with regards to leases:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">l2announcements.leaseDuration</span></code> determines the <code class="docutils literal notranslate"><span class="pre">leaseDurationSeconds</span></code> value
of created leases and by extent how long a leader must be “down” before
failover occurs. Its default value is 15s, it must always be greater than 1s
and be larger than <code class="docutils literal notranslate"><span class="pre">leaseRenewDeadline</span></code>.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">l2announcements.leaseRenewDeadline</span></code> is the interval at which the leader
should renew the lease. Its default value is 5s, it must be greater than
<code class="docutils literal notranslate"><span class="pre">leaseRetryPeriod</span></code> by at least 20% and is not allowed to be below <code class="docutils literal notranslate"><span class="pre">1ns</span></code>.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">l2announcements.leaseRetryPeriod</span></code> if renewing the lease fails, how long
should the agent wait before it tries again. Its default value is 2s, it
must be smaller than <code class="docutils literal notranslate"><span class="pre">leaseRenewDeadline</span></code> by at least 20% and above <code class="docutils literal notranslate"><span class="pre">1ns</span></code>.</p></li>
</ul>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The theoretical shortest time between failure and failover is
<code class="docutils literal notranslate"><span class="pre">leaseDuration</span> <span class="pre">-</span> <span class="pre">leaseRenewDeadline</span></code> and the longest <code class="docutils literal notranslate"><span class="pre">leaseDuration</span> <span class="pre">+</span> <span class="pre">leaseRenewDeadline</span></code>.
So with the default values, failover occurs between 10s and 20s.
For the example below, these times are between 2s and 4s.</p>
</div>
<div class="sphinx-tabs docutils container">
<div aria-label="Tabbed content" class="closeable" role="tablist"><button aria-controls="panel-1-SGVsbQ==" aria-selected="true" class="sphinx-tabs-tab group-tab" id="tab-1-SGVsbQ==" name="SGVsbQ==" role="tab" tabindex="0">Helm</button><button aria-controls="panel-1-Q29uZmlnTWFw" aria-selected="false" class="sphinx-tabs-tab group-tab" id="tab-1-Q29uZmlnTWFw" name="Q29uZmlnTWFw" role="tab" tabindex="-1">ConfigMap</button></div><div aria-labelledby="tab-1-SGVsbQ==" class="sphinx-tabs-panel group-tab" id="panel-1-SGVsbQ==" name="SGVsbQ==" role="tabpanel" tabindex="0"><pre class="literal-block">$ helm upgrade cilium cilium/cilium --version 1.18.2 \
   --namespace kube-system \
   --reuse-values \
   --set l2announcements.enabled=true \
   --set kubeProxyReplacement=true \
   --set k8sServiceHost=${API_SERVER_IP} \
   --set k8sServicePort=${API_SERVER_PORT} \
   --set k8sClientRateLimit.qps={QPS} \
   --set k8sClientRateLimit.burst={BURST} \
   --set l2announcements.leaseDuration=3s \
   --set l2announcements.leaseRenewDeadline=1s \
   --set l2announcements.leaseRetryPeriod=200ms</pre>
</div><div aria-labelledby="tab-1-Q29uZmlnTWFw" class="sphinx-tabs-panel group-tab" hidden="true" id="panel-1-Q29uZmlnTWFw" name="Q29uZmlnTWFw" role="tabpanel" tabindex="0"><div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">enable-l2-announcements</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
<span class="nt">kube-proxy-replacement</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
<span class="nt">l2-announcements-lease-duration</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">3s</span>
<span class="nt">l2-announcements-renew-deadline</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1s</span>
<span class="nt">l2-announcements-retry-period</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">200ms</span>
<span class="nt">k8s-client-qps</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">{</span><span class="nv">QPS</span><span class="p p-Indicator">}</span>
<span class="nt">k8s-client-burst</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">{</span><span class="nv">BURST</span><span class="p p-Indicator">}</span>
</pre></div>
</div>
</div></div>
<p>There is a trade-off between fast failure detection and CPU + network usage.
Each service incurs a CPU and network overhead, so clusters with smaller amounts
of services can more easily afford faster failover times. Larger clusters might
need to increase parameters if the overhead is too high.</p>
<section id="sizing-client-rate-limit">
<span id="id1"></span><h4>Sizing client rate limit<a class="headerlink" href="#sizing-client-rate-limit" title="Permalink to this heading"></a></h4>
<p>The leader election process continually generates API traffic, the exact amount
depends on the configured lease duration, configured renew deadline, and amount
of services using the feature.</p>
<p>The default client rate limit is 5 QPS with allowed bursts up to 10 QPS. this
default limit is quickly reached when utilizing L2 announcements and thus users
should size the client rate limit accordingly.</p>
<p>In a worst case scenario, services are distributed unevenly, so we will assume
a peak load based on the renew deadline. In complex scenarios with multiple
policies over disjointed sets of node, max QPS per node will be lower.</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>QPS = #services * (1 / leaseRenewDeadline)

// example
#services = 65
leaseRenewDeadline = 2s
QPS = 65 * (1 / 2s) = 32.5 QPS
</pre></div>
</div>
<p>Setting the base QPS to around the calculated value should be sufficient, given
in multi-node scenarios leases are spread around nodes, and non-holders participating
in the election have a lower QPS.</p>
<p>The burst QPS should be slightly higher to allow for bursts of traffic caused
by other features which also use the API server.</p>
</section>
</section>
<section id="failover">
<h3>Failover<a class="headerlink" href="#failover" title="Permalink to this heading"></a></h3>
<p>When nodes participating in leader election detect that the lease holder did not
renew the lease for <code class="docutils literal notranslate"><span class="pre">leaseDurationSeconds</span></code> amount of seconds, they will ask
the API server to make them the new holder. The first request to be processed
gets through and the rest are denied.</p>
<p>When a node becomes the leader/holder, it will send out a gratuitous ARP reply
over all of the configured interfaces. Clients who accept these will update
their ARP tables at once causing them to send traffic to the new leader/holder.
Not all clients accept gratuitous ARP replies since they can be used for ARP spoofing.
Such clients might experience longer downtime then configured in the leases
since they will only re-query via ARP when TTL in their internal tables
has been reached.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Since this feature has no IPv6 support yet, only ARP messages are sent, no
Unsolicited Neighbor Advertisements are sent.</p>
</div>
</section>
</section>
<section id="troubleshooting">
<h2>Troubleshooting<a class="headerlink" href="#troubleshooting" title="Permalink to this heading"></a></h2>
<p>This section is a step by step guide on how to troubleshoot L2 Announcements,
hopefully solving your issue or narrowing it down to a specific area.</p>
<p>The first thing we need to do is to check that the feature is enabled, kube proxy replacement
is active and optionally that external IPs are enabled.</p>
<div class="highlight-shell-session notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>kubectl<span class="w"> </span>-n<span class="w"> </span>kube-system<span class="w"> </span><span class="nb">exec</span><span class="w"> </span>ds/cilium<span class="w"> </span>--<span class="w"> </span>cilium-dbg<span class="w"> </span>config<span class="w"> </span>--all<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>EnableL2Announcements
<span class="go">EnableL2Announcements             : true</span>

<span class="gp">$ </span>kubectl<span class="w"> </span>-n<span class="w"> </span>kube-system<span class="w"> </span><span class="nb">exec</span><span class="w"> </span>ds/cilium<span class="w"> </span>--<span class="w"> </span>cilium-dbg<span class="w"> </span>config<span class="w"> </span>--all<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>KubeProxyReplacement
<span class="go">KubeProxyReplacement              : true</span>

<span class="gp">$ </span>kubectl<span class="w"> </span>-n<span class="w"> </span>kube-system<span class="w"> </span><span class="nb">exec</span><span class="w"> </span>ds/cilium<span class="w"> </span>--<span class="w"> </span>cilium-dbg<span class="w"> </span>config<span class="w"> </span>--all<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>EnableExternalIPs
<span class="go">EnableExternalIPs                 : true</span>
</pre></div>
</div>
<p>If <code class="docutils literal notranslate"><span class="pre">EnableL2Announcements</span></code> or <code class="docutils literal notranslate"><span class="pre">KubeProxyReplacement</span></code> indicates <code class="docutils literal notranslate"><span class="pre">false</span></code>, make sure to enable the
correct settings and deploy the helm chart <a class="reference internal" href="#l2-announcements-settings"><span class="std std-ref">Configuration</span></a>. <code class="docutils literal notranslate"><span class="pre">EnableExternalIPs</span></code> should be set to <code class="docutils literal notranslate"><span class="pre">true</span></code> if you intend to use external IPs.</p>
<p>Next, ensure you have at least one policy configured, L2 announcements will not work without a policy.</p>
<div class="highlight-shell-session notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>kubectl<span class="w"> </span>get<span class="w"> </span>CiliumL2AnnouncementPolicy
<span class="go">NAME      AGE</span>
<span class="go">policy1   6m16s</span>
</pre></div>
</div>
<p>L2 announcements should now create a lease for every service matched by the policy. We can check the leases like so:</p>
<div class="highlight-shell-session notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>kubectl<span class="w"> </span>-n<span class="w"> </span>kube-system<span class="w"> </span>get<span class="w"> </span>lease<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span><span class="s2">&quot;cilium-l2announce&quot;</span>
<span class="go">cilium-l2announce-default-service-red   kind-worker                       34s</span>
</pre></div>
</div>
<p>If the output is empty, then the policy is not correctly configured or the agent is not running correctly.
Check the logs of the agent for error messages:</p>
<div class="highlight-shell-session notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>kubectl<span class="w"> </span>-n<span class="w"> </span>kube-system<span class="w"> </span>logs<span class="w"> </span>ds/cilium<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span><span class="s2">&quot;l2&quot;</span>
</pre></div>
</div>
<p>A common error is that the agent is not able to create leases.</p>
<div class="highlight-shell-session notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>kubectl<span class="w"> </span>-n<span class="w"> </span>kube-system<span class="w"> </span>logs<span class="w"> </span>ds/cilium<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span><span class="s2">&quot;error&quot;</span>
<span class="go">time=&quot;2024-06-25T12:01:43Z&quot; level=error msg=&quot;error retrieving resource lock kube-system/cilium-l2announce-default-service-red: leases.coordination.k8s.io \&quot;cilium-l2announce-default-service-red\&quot; is forbidden: User \&quot;system:serviceaccount:kube-system:cilium\&quot; cannot get resource \&quot;leases\&quot; in API group \&quot;coordination.k8s.io\&quot; in the namespace \&quot;kube-system\&quot;&quot; subsys=klog</span>
</pre></div>
</div>
<p>This can happen if the cluster role of the agent is not correct. This tends to happen when L2 announcements is enabled
without using the helm chart. Redeploy the helm chart or manually update the cluster role, by running
<code class="docutils literal notranslate"><span class="pre">kubectl</span> <span class="pre">edit</span> <span class="pre">clusterrole</span> <span class="pre">cilium</span></code> and adding the following block to the rules:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">apiGroups</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">coordination.k8s.io</span>
<span class="w">  </span><span class="nt">resources</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">leases</span>
<span class="w">  </span><span class="nt">verbs</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">create</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">get</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">update</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">list</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">delete</span>
</pre></div>
</div>
<p>Another common error is that the configured client rate limit is too low.
This can be seen in the logs as well:</p>
<div class="highlight-shell-session notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>kubectl<span class="w"> </span>-n<span class="w"> </span>kube-system<span class="w"> </span>logs<span class="w"> </span>ds/cilium<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span><span class="s2">&quot;l2&quot;</span>
<span class="go">2023-07-04T14:59:51.959400310Z level=info msg=&quot;Waited for 1.395439596s due to client-side throttling, not priority and fairness, request: GET:https://127.0.0.1:6443/apis/coordination.k8s.io/v1/namespaces/kube-system/leases/cilium-l2announce-default-example&quot; subsys=klog</span>
<span class="go">2023-07-04T15:00:12.159409007Z level=info msg=&quot;Waited for 1.398748976s due to client-side throttling, not priority and fairness, request: PUT:https://127.0.0.1:6443/apis/coordination.k8s.io/v1/namespaces/kube-system/leases/cilium-l2announce-default-example&quot; subsys=klog</span>
</pre></div>
</div>
<p>These logs are associated with intermittent failures to renew the lease, connection issues and/or frequent leader changes.
See <a class="reference internal" href="#sizing-client-rate-limit"><span class="std std-ref">Sizing client rate limit</span></a> for more information on how to size the client rate limit.</p>
<p>If you find a different L2 related error, please open a GitHub issue with the error message and the
steps you took to get there.</p>
<p>Assuming the leases are created, the next step is to check the agent internal state. Pick a service which isn’t working
and inspect its lease. Take the holder name and find the cilium agent pod for the holder node.
Finally, take the name of the cilium agent pod and inspect the l2-announce state:</p>
<div class="highlight-shell-session notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>kubectl<span class="w"> </span>-n<span class="w"> </span>kube-system<span class="w"> </span>get<span class="w"> </span>lease<span class="w"> </span>cilium-l2announce-default-service-red
<span class="go">NAME                                    HOLDER        AGE</span>
<span class="go">cilium-l2announce-default-service-red   &lt;node-name&gt;   20m</span>

<span class="gp">$ </span>kubectl<span class="w"> </span>-n<span class="w"> </span>kube-system<span class="w"> </span>get<span class="w"> </span>pod<span class="w"> </span>-l<span class="w"> </span><span class="s1">&#39;app.kubernetes.io/name=cilium-agent&#39;</span><span class="w"> </span>-o<span class="w"> </span>wide<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>&lt;node-name&gt;
<span class="go">&lt;agent-pod&gt;   1/1     Running   0          35m   172.19.0.3   kind-worker          &lt;none&gt;           &lt;none&gt;</span>

<span class="gp">$ </span>kubectl<span class="w"> </span>-n<span class="w"> </span>kube-system<span class="w"> </span><span class="nb">exec</span><span class="w"> </span>pod/&lt;agent-pod&gt;<span class="w"> </span>--<span class="w"> </span>cilium-dbg<span class="w"> </span>shell<span class="w"> </span>--<span class="w"> </span>db/show<span class="w"> </span>l2-announce
<span class="gp"># </span>IP<span class="w">        </span>NetworkInterface
<span class="go">10.0.10.0   eth0</span>
</pre></div>
</div>
<p>The l2 announce state should contain the IP of the service and the network interface it is announced on.
If the lease is present but its IP is not in the l2-announce state, or you are missing an entry for a given network device.
Double check that the device selector in the policy matches the desired network device (values are regular expressions).
If the filter seems correct or isn’t specified, inspect the known devices:</p>
<div class="highlight-shell-session notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>kubectl<span class="w"> </span>-n<span class="w"> </span>kube-system<span class="w"> </span><span class="nb">exec</span><span class="w"> </span>ds/cilium<span class="w"> </span>--<span class="w"> </span>cilium-dbg<span class="w"> </span>shell<span class="w"> </span>--<span class="w"> </span>db/show<span class="w"> </span>devices
<span class="go">Name              Index   Selected   Type     MTU     HWAddr              Flags                    Addresses</span>
<span class="go">lxc5d23398605f6   10      false      veth     1500    b6:ed:d8:d2:dd:ec   up|broadcast|multicast   fe80::b4ed:d8ff:fed2:ddec</span>
<span class="go">lxc3bf03c00d6e3   12      false      veth     1500    8a:d1:0c:91:8a:d3   up|broadcast|multicast   fe80::88d1:cff:fe91:8ad3</span>
<span class="go">eth0              50      true       veth     1500    02:42:ac:13:00:03   up|broadcast|multicast   172.19.0.3, fc00:c111::3, fe80::42:acff:fe13:3</span>
<span class="go">lo                1       false      device   65536                       up|loopback              127.0.0.1, ::1</span>
<span class="go">cilium_net        2       false      veth     1500    1a:a9:2f:4d:d3:3d   up|broadcast|multicast   fe80::18a9:2fff:fe4d:d33d</span>
<span class="go">cilium_vxlan      4       false      vxlan    1500    2a:05:26:8d:79:9c   up|broadcast|multicast   fe80::2805:26ff:fe8d:799c</span>
<span class="go">lxc611291f1ecbb   8       false      veth     1500    7a:fb:ec:54:e2:5c   up|broadcast|multicast   fe80::78fb:ecff:fe54:e25c</span>
<span class="go">lxc_health        16      false      veth     1500    0a:94:bf:49:d5:50   up|broadcast|multicast   fe80::894:bfff:fe49:d550</span>
<span class="go">cilium_host       3       false      veth     1500    22:32:e2:80:21:34   up|broadcast|multicast   10.244.1.239, fd00:10:244:1::f58a</span>
</pre></div>
</div>
<p>Only devices with <code class="docutils literal notranslate"><span class="pre">Selected</span></code> set to <code class="docutils literal notranslate"><span class="pre">true</span></code> can be used for L2 announcements. Typically all physical devices with IPs
assigned to them will be considered selected. The <code class="docutils literal notranslate"><span class="pre">--devices</span></code> flag or <code class="docutils literal notranslate"><span class="pre">devices</span></code> Helm option can be used to filter
out devices. If your desired device is in the list but not selected, check the devices flag/option to see if it filters it out.</p>
<p>Please open a Github issue if your desired device doesn’t appear in the list or it isn’t selected while you believe it should be.</p>
<p>If the L2 state contains the IP and device combination but there are still connection issues, it’s time to test ARP
within the cluster. Pick a cilium agent pod other than the lease holder on the same L2 network.
Then use the following command to send an ARP request to the service IP:</p>
<div class="highlight-shell-session notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>kubectl<span class="w"> </span>-n<span class="w"> </span>kube-system<span class="w"> </span><span class="nb">exec</span><span class="w"> </span>pod/cilium-z4ef7<span class="w"> </span>--<span class="w"> </span>sh<span class="w"> </span>-c<span class="w"> </span><span class="s1">&#39;apt update &amp;&amp; apt install -y arping &amp;&amp; arping -i &lt;netdev-on-l2&gt; &lt;service-ip&gt;&#39;</span>
<span class="go">[omitting apt output...]</span>
<span class="go">ARPING 10.0.10.0</span>
<span class="go">58 bytes from 02:42:ac:13:00:03 (10.0.10.0): index=0 time=11.772 usec</span>
<span class="go">58 bytes from 02:42:ac:13:00:03 (10.0.10.0): index=1 time=9.234 usec</span>
<span class="go">58 bytes from 02:42:ac:13:00:03 (10.0.10.0): index=2 time=10.568 usec</span>
</pre></div>
</div>
<p>If the output is as above yet the service is still unreachable, from clients within the same L2 network,
the issue might be client related. If you expect the service to be reachable from outside the L2 network,
and it is not, check the ARP and routing tables of the gateway device.</p>
<p>If the ARP request fails (the output shows <code class="docutils literal notranslate"><span class="pre">Timeout</span></code>), check the BPF map of the cilium-agent with the lease:</p>
<div class="highlight-shell-session notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>kubectl<span class="w"> </span>-n<span class="w"> </span>kube-system<span class="w"> </span><span class="nb">exec</span><span class="w"> </span>pod/cilium-vxz67<span class="w"> </span>--<span class="w"> </span>bpftool<span class="w"> </span>map<span class="w"> </span>dump<span class="w"> </span>pinned<span class="w"> </span>/sys/fs/bpf/tc/globals/cilium_l2_responder_v4
<span class="go">[{</span>
<span class="go">        &quot;key&quot;: {</span>
<span class="go">            &quot;ip4&quot;: 655370,</span>
<span class="go">            &quot;ifindex&quot;: 50</span>
<span class="go">        },</span>
<span class="go">        &quot;value&quot;: {</span>
<span class="go">            &quot;responses_sent&quot;: 20</span>
<span class="go">        }</span>
<span class="go">    }</span>
<span class="go">]</span>
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">responses_sent</span></code> field is incremented every time the datapath responds to an ARP request. If the field
is 0, then the ARP request doesn’t make it to the node. If the field is greater than 0, the issue is on the
return path. In both cases, inspect the network and the client.</p>
<p>It is still possible that the service is unreachable even though ARP requests are answered. This can happen
for a number of reasons, usually unrelated to L2 announcements, but rather other Cilium features.</p>
<p>One common issue however is caused by the usage of <code class="docutils literal notranslate"><span class="pre">.Spec.ExternalTrafficPolicy:</span> <span class="pre">Local</span></code> on services. This setting
normally tells a load balancer to only forward traffic to nodes with at least 1 ready pod to avoid a second hop.
Unfortunately, L2 announcements isn’t currently aware of this setting and will announce the service IP on all nodes
matching policies. If a node without a pod receives traffic, it will drop it. To fix this, set the policy to
<code class="docutils literal notranslate"><span class="pre">.Spec.ExternalTrafficPolicy:</span> <span class="pre">Cluster</span></code>.</p>
<p>Please open a Github issue if none of the above steps helped you solve your issue.</p>
</section>
<section id="l2-pod-announcements">
<span id="id2"></span><h2>L2 Pod Announcements<a class="headerlink" href="#l2-pod-announcements" title="Permalink to this heading"></a></h2>
<p>L2 Pod Announcements announce Pod IP addresses on the L2 network using
Gratuitous ARP replies. When enabled, the node transmits Gratuitous ARP
replies for every locally created pod, on the configured network
interface(s). This feature is enabled separately from the above L2
announcements feature.</p>
<p>To enable L2 Pod Announcements, set the following:</p>
<div class="sphinx-tabs docutils container">
<div aria-label="Tabbed content" class="closeable" role="tablist"><button aria-controls="panel-2-SGVsbQ==" aria-selected="true" class="sphinx-tabs-tab group-tab" id="tab-2-SGVsbQ==" name="SGVsbQ==" role="tab" tabindex="0">Helm</button><button aria-controls="panel-2-Q29uZmlnTWFw" aria-selected="false" class="sphinx-tabs-tab group-tab" id="tab-2-Q29uZmlnTWFw" name="Q29uZmlnTWFw" role="tab" tabindex="-1">ConfigMap</button></div><div aria-labelledby="tab-2-SGVsbQ==" class="sphinx-tabs-panel group-tab" id="panel-2-SGVsbQ==" name="SGVsbQ==" role="tabpanel" tabindex="0"><pre class="literal-block">$ helm upgrade cilium cilium/cilium --version 1.18.2 \
   --namespace kube-system \
   --reuse-values \
   --set l2podAnnouncements.enabled=true \
   --set l2podAnnouncements.interface=eth0</pre>
</div><div aria-labelledby="tab-2-Q29uZmlnTWFw" class="sphinx-tabs-panel group-tab" hidden="true" id="panel-2-Q29uZmlnTWFw" name="Q29uZmlnTWFw" role="tabpanel" tabindex="0"><div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">enable-l2-pod-announcements</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
<span class="nt">l2-pod-announcements-interface</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">eth0</span>
</pre></div>
</div>
</div></div>
<p>The <code class="docutils literal notranslate"><span class="pre">l2podAnnouncements.interface</span></code>/<code class="docutils literal notranslate"><span class="pre">l2-pod-announcements-interface</span></code> options allows you to specify
one interface use to send announcements.  If you would like to send announcements on multiple interfaces, you should use the
<code class="docutils literal notranslate"><span class="pre">l2podAnnouncements.interfacePattern</span></code>/<code class="docutils literal notranslate"><span class="pre">l2-pod-announcements-interface-pattern</span></code> option instead.
This option takes a regex, matching on multiple interfaces.</p>
<div class="sphinx-tabs docutils container">
<div aria-label="Tabbed content" class="closeable" role="tablist"><button aria-controls="panel-3-SGVsbQ==" aria-selected="true" class="sphinx-tabs-tab group-tab" id="tab-3-SGVsbQ==" name="SGVsbQ==" role="tab" tabindex="0">Helm</button><button aria-controls="panel-3-Q29uZmlnTWFw" aria-selected="false" class="sphinx-tabs-tab group-tab" id="tab-3-Q29uZmlnTWFw" name="Q29uZmlnTWFw" role="tab" tabindex="-1">ConfigMap</button></div><div aria-labelledby="tab-3-SGVsbQ==" class="sphinx-tabs-panel group-tab" id="panel-3-SGVsbQ==" name="SGVsbQ==" role="tabpanel" tabindex="0"><pre class="literal-block">$ helm upgrade cilium cilium/cilium --version 1.18.2 \
   --namespace kube-system \
   --reuse-values \
   --set l2podAnnouncements.enabled=true \
   --set l2podAnnouncements.interfacePattern='^(eth0|ens1)$'</pre>
</div><div aria-labelledby="tab-3-Q29uZmlnTWFw" class="sphinx-tabs-panel group-tab" hidden="true" id="panel-3-Q29uZmlnTWFw" name="Q29uZmlnTWFw" role="tabpanel" tabindex="0"><div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">enable-l2-pod-announcements</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
<span class="nt">l2-pod-announcements-interface-pattern</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;^(eth0|ens1)$&quot;</span>
</pre></div>
</div>
</div></div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Since this feature has no IPv6 support yet, only ARP messages are
sent, no Unsolicited Neighbor Advertisements are sent.</p>
</div>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="../vtep/" class="btn btn-neutral float-left" title="VXLAN Tunnel Endpoint (VTEP) Integration (beta)" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="../node-ipam/" class="btn btn-neutral float-right" title="Node IPAM LB" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright Cilium Authors.
      <span class="lastupdated">Last updated on Sep 16, 2025.
      </span></p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
 
  <script>
    document.addEventListener(
      "readthedocs-addons-data-ready",
      function (event) {
        const config = event.detail.data();
    
        // Create the version selector HTML
        const versionSelector = `
          <div class="rst-versions" data-toggle="rst-versions" role="note" aria-label="Versions">
            <span class="rst-current-version" data-toggle="rst-current-version">
              <span class="rst-current-version-label">Read the Docs</span>
              version: ${config.versions.current.slug}
              <span class="fa fa-caret-down"></span>
            </span>
            <div class="rst-other-versions">
              <dl>
                <dt>Versions</dt>
                ${config.versions.active
                  .map(version => `
                    <dd><a href="${version.urls.documentation}">${version.slug}</a></dd>
                  `).join('')}
              </dl>
            </div>
          </div>
        `;
    
        // Insert the version selector into your page
        document.querySelector('.wy-nav-wrapper')
          .insertAdjacentHTML('beforeend', versionSelector);
      }
    );
  </script>
  
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

  <script>
    setTimeout(() => {
      docsearch({
        indexName: 'cilium_docs',
        apiKey: 'ebd279472edfb5246bababfd1f324a98',
        appId: 'NR0TQZZ2NG', 
        inputSelector: '#rtd-search-form input, #flyout-search-form input',
        debug: false,
        algoliaOptions: {
          'facetFilters': ['version:stable']
        }
      });
    }, 0);
  </script>

</body>
</html>